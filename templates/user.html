
{% extends "base.html" %}
{% import "wtf.html" as wtf %}

{% block head %}
    <style>
        .center {
            padding: 40px 15px;
            text-align: center;
        }
    </style>
{% endblock %}

{% block content %}
<nav class="navbar navbar-inverse navbar-static-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">app</a>
        </div>
        <div class="collapse navbar-collapse">
            <ul class="nav navbar-nav navbar-right">
                <li><a href="/marketplace">Marketplace</a></li>

                {% if not current_user.is_authenticated %}
                <li><p style="padding:8px 0 0 10px;"><a href="/signup"
                                                            class="btn btn-primary" style="color:#fff;">Sign Up For
                                Free</a></p></li>
                <li><a href="/login">Login</a></li>
                {% else %}
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">{{ current_user.name }} <span class="caret"></span></a>
                    <ul class="dropdown-menu">
                      <li><a href="/settings">Account settings</a></li>
                     <li><a href="/user/{{ current_user.id }}">Requests and posts</a></li>
                                                                 {% if current_user.type != 'Brand/Agency' %}
                            <li><a href="/addfunds">Add funds</a></li>
                            {% endif %}
                                          <li><a href="/withdrawal">Withdrawal</a></li>
                         {% if current_user.type == 'Brand/Agency' %}
                            <li><a href="/add_channel">Add channel</a></li>
                            {% endif %}
                      <li role="separator" class="divider"></li>
                      <li><a href="/logout">Log out</a></li>
                    </ul>
                </li>
                {% endif %}
            </ul>
        </div>
        <!--/.nav-collapse -->
    </div>
    <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
    <div class="content">
        <div class="page-header">
            <h3>Requests and Posts</h3>
        </div>
        <div class="page-body">
             {% with alerts = get_flashed_messages() %}
        {% if alerts %}
            {% for alert in alerts %}
                {% if "Success" in alert or 'Great' in alert %}
                    <div class="alert alert-success">
                      {{ alert }}
                    </div>
                {% else %}
                    <div class="alert alert-danger">
                      {{ alert }}
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endwith %}

            {% if current_user.email_confirmed == 0 %}
                <div class="alert alert-warning">
                    <strong>Please</strong>, confirm your email!
                </div>
            {% endif %}



        {% if current_user.type == 'Brand/Agency' %}
            {% if user.channels.all() %}

                <div class="table-responsive">
              <table class="table table-sm table-dark">
                  <thead>
                  <tr>
                      <th scope="col">#</th>
                      <th scope="col">Channel</th>
                      <th scope="col">Project Link</th>
                      <th scope="col">Ad Content</th>
                      <th scope="col">Comment</th>
                      <th scope="col"></th>
                      <th scope="col"></th>
                  </tr>
                  </thead>
                  <tbody>

                  {% for channel in user.channels.all() %}
                      {% for request in channel.requests.all() %}
                          <tr>

                              {% if request.declined == 0 %}
                                  <td scope="row">{{ loop.index }}</td>
                                  <td id="test">{{ channel.name }}</td>
                                  <td><a href="{{ request.link }}">{{ request.link }}</a></td>
                                  <td><b>{{ request.content }}</b></td>
                                  <td><b>{{ request.comment }}</b></td>
                                  {% if request.confirmed == 0 %}
                                      <td><a href="/accept_request?request_id={{ request.id }}">
                                          <button class="btn">Accept</button>
                                      </a></td>
                                      <td><a href="/decline_request?request_id={{ request.id }}">
                                          <button class="btn btn-warning">Decline</button>
                                      </a></td>
                                      <td></td>
                                  {% elif request.posted == 0 %}
                                      <form action="/confirmSHARELINK" method="POST">
                                          <td>
                                              <input type="text" class="form-control" name="link">
                                          </td>
                                          <td><input type="hidden" class="form-control" value="{{ request.id }}" name="request_id"></td>
                                      <td><button type="submit" class="btn btn-success">Confirm</button></td>
                                      </form>
                                  {% else %}
                                      <td><b>Already posted</b></td>
                                      <td><b>Must be on the channel till {{ request.post_time }}</b></td>
                                      <td></td>
                                  {% endif %}
                                  {% elif request.posted == 1 %}
                                  <td scope="row">{{ loop.index }}</td>
                                  <td id="test">{{ channel.name }}</td>
                                  <td><a href="{{ request.link }}">{{ request.link }}</a></td>
                                  <td><b>{{ request.content }}</b></td>
                                  <td><b>{{ request.comment }}</b></td>
                                  <td><b>Breaking rules detected - post vanished earlier than {{ request.post_time }}! Funds on your virtual wallet are not valid anymore :(</b></td>
                                  <td></td>
                              {% endif %}
                          </tr>
                      {% endfor %}
                  {% endfor %}
                  </tbody>
              </table>
                </div>
              {% else %}
              <h1>Ain't no channel of yours.</h1>
          {% endif %}
        {% else %}

            <div class="table-responsive">
             <table class="table table-sm table-dark">
  <thead>
    <tr>
      <th scope="col">#</th>
      <th scope="col">Content </th>
      <th scope="col">Project Link</th>
      <th scope="col">Status</th>
      <th scope="col">Comment</th>
        <!--part to cancel the request-->
      <th scope="col"></th>
    </tr>
  </thead>
  <tbody>

  {% for post in user.posts.all() %}
          <tr>
                <td scope="row">{{ loop.index }}</td>
              <td id="test">{{ post.content }}</td>
              <td><a href="{{ post.link }}">{{ post.link }}</a></td>
              {% if post.confirmed == 0 and post.declined == 0 %}
                  <td><b>Under Consideration</b></td>
                  <td><b>Your request is being considered by the channels administrator...</b></td>
                  <td><a href="/rollback?post_id={{ post.id }}"><button class="btn">Cancel request</button></a></td>
                  {% elif post.posted == 1 and post.declined == 0 and post.post_time > time_now%}
                  <td><b>Posted!</b></td>
                  <td><b>Now your post is on the channel! Will be there till {{ post.post_time }} UTC. Check it out -> <a href="{{ post.SHARELINK }}">{{ post.SHARELINK }}</a></b></td>
                  <td><a href="/complain?post_id={{ post.id }}"><button class="btn">Complain</button></a></td>
                  {% elif post.confirmed == 1 and post.declined == 0 and post.posted == 0 %}
                  <td><b>Accepted!</b></td>
                  <td><b>Now the administrator of the channel has 48 hours to post the ad.</b></td>
                  <td></td>
                  {% elif post.posted == 1 and post.declined == 1 %}
                  <td><b>Annulled!</b></td>
                  <td><b>Your complain was considered and refunded.</b></td>
                  <td><a href="/remove_row?post_id={{ post.id }}"><button class="btn">Remove</button></a></td>
                  {% else %}
                  <td><b>Declined</b></td>
                  <td><b>Sorry! The administrator of the channel didn't accept your ad request.</b></td>
                  <td><a href="/remove_row?post_id={{ post.id }}"><button class="btn">Remove</button></a></td>
{#                  <td><a href="/switch_channel?post_id={{ post.id }}"><button class="btn">Switch channel</button></a></td>#}
              {% endif %}
          </tr>
  {% endfor %}
  </tbody>
</table>

            </div>
        {% endif %}





    </div>
</div>
{% endblock %}
